<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenGrid UK | Civic Debugging Platform</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- CYBERPUNK THEME --- */
        body { margin: 0; background: #050505; color: white; font-family: 'Courier New', Courier, monospace; overflow: hidden; }
        
        /* Dark Mode Map Filters */
        .leaflet-layer, .leaflet-control-zoom-in, .leaflet-control-zoom-out, .leaflet-control-attribution {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
        
        /* Custom Pins */
        .marker-pin { width: 20px; height: 20px; border-radius: 50%; background: #00FFFF; border: 2px solid white; box-shadow: 0 0 15px #00FFFF; animation: pulse 2s infinite; }
        .marker-pin.critical { background: #FF00FF; box-shadow: 0 0 15px #FF00FF; animation: pulse-critical 1.5s infinite; }
        .marker-pin.resolved { background: #22c55e; box-shadow: 0 0 15px #22c55e; border-color: #bbf7d0; animation: none; opacity: 0.6; }
        .marker-pin.traffic { background: #ef4444; border-color: #7f1d1d; box-shadow: 0 0 15px #ef4444; animation: pulse-critical 0.5s infinite; }
        .marker-pin.news { background: #3b82f6; border-color: #eff6ff; box-shadow: 0 0 15px #3b82f6; animation: pulse 3s infinite; }
        .marker-pin.prediction { background: #f97316; border-color: #c2410c; box-shadow: 0 0 20px #f97316; animation: pulse 1s infinite; }

        /* Animations */
        @keyframes pulse { 0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(0, 255, 255, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 255, 255, 0); } 100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(0, 255, 255, 0); } }
        @keyframes pulse-critical { 0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255, 0, 255, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 0, 255, 0); } 100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255, 0, 255, 0); } }
        @keyframes dash { to { stroke-dashoffset: -100; } }
        
        /* News Ticker */
        @keyframes ticker { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .ticker-wrap { width: 100%; overflow: hidden; background: #000; border-top: 1px solid #333; position: fixed; bottom: 0; height: 32px; z-index: 2000; display: flex; items-center; }
        .ticker-move { display: inline-block; white-space: nowrap; animation: ticker 60s linear infinite; }
        .ticker-item { display: inline-block; padding: 0 2rem; font-size: 12px; font-weight: bold; text-transform: uppercase; color: #00FFFF; }

        /* Transitions */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #reportModal { transition: opacity 0.2s ease-in-out; }

        /* Scrollbar for chat */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>

    <nav class="fixed top-0 w-full z-[1000] bg-black/90 backdrop-blur border-b border-white/10 h-16 flex justify-between items-center px-6">
        <div class="text-xl font-bold uppercase italic flex items-center gap-3">
            <i data-lucide="globe" class="text-cyan-400"></i>
            <span class="tracking-tighter">OpenGrid <span class="text-cyan-400">UK</span></span>
        </div>
        
        <div class="flex items-center gap-4 text-xs font-bold uppercase tracking-widest text-gray-500">
            <a href="analytics.html" class="hidden md:flex items-center gap-2 text-gray-400 hover:text-white border border-transparent hover:border-white/30 px-3 py-1 rounded transition-colors decoration-0">
                <i data-lucide="bar-chart-2" class="w-3 h-3"></i> Data
            </a>

            <button onclick="toggleHeatmap()" id="heat-btn" class="hidden md:flex items-center gap-2 text-pink-400 border border-pink-500/30 px-3 py-1 rounded hover:bg-pink-900/20 transition-colors">
                <i data-lucide="flame" class="w-3 h-3"></i> Heat Map
            </button>
            
            <button onclick="toggleRealTraffic()" id="traffic-btn" class="hidden md:flex items-center gap-2 text-orange-400 border border-orange-500/30 px-3 py-1 rounded hover:bg-orange-900/20 transition-colors">
                <i data-lucide="activity" class="w-3 h-3"></i> Live Traffic
            </button>

            <button onclick="toggleNews()" id="news-btn" class="hidden md:flex items-center gap-2 text-blue-400 border border-blue-500/30 px-3 py-1 rounded hover:bg-blue-900/20 transition-colors">
                <i data-lucide="newspaper" class="w-3 h-3"></i> Local News
            </button>

            <button onclick="toggleTheme()" id="theme-btn" class="hidden md:flex items-center gap-2 text-white border border-white/30 px-3 py-1 rounded hover:bg-white/10 transition-colors">
                <i data-lucide="moon" class="w-3 h-3"></i> Theme
            </button>

            <div class="pl-4 border-l border-white/10 flex items-center gap-3">
                <span id="user-display" class="text-white">Guest</span>
                <a href="admin.html" target="_blank" class="flex items-center gap-1 text-[10px] text-orange-500 border border-orange-900 bg-orange-900/10 px-2 py-1 hover:bg-orange-900/50 rounded transition-colors">
                    <i data-lucide="lock" class="w-3 h-3"></i> Staff
                </a>
            </div>
            <div class="hidden md:block">Nodes: <span id="bug-count" class="text-white">0</span></div>
        </div>
    </nav>

    <div class="fixed top-16 left-0 right-0 z-[999] bg-black/80 border-b border-white/10 px-6 py-3">
        <div class="flex gap-4 items-center text-xs">
            <input type="text" id="searchInput" placeholder="Search issues..." 
                onkeypress="if(event.key === 'Enter') applyFilters()"
                class="flex-1 bg-black/40 border border-white/20 rounded px-3 py-2 text-white placeholder-gray-600 focus:outline-none focus:border-cyan-500/50">
            <select id="filterType" class="bg-black/40 border border-white/20 rounded px-3 py-2 text-white focus:outline-none focus:border-cyan-500/50 text-xs">
                <option value="">All Types</option>
                <option value="critical">Critical</option>
                <option value="traffic">Traffic</option>
                <option value="news">News</option>
            </select>
            <button onclick="applyFilters()" class="bg-cyan-600 hover:bg-cyan-500 text-black px-4 py-2 rounded font-bold transition-colors">Search</button>
        </div>
    </div>

    <div id="weather-widget" class="fixed top-32 right-6 z-[950] bg-black/90 border border-cyan-500/30 p-4 rounded backdrop-blur-md shadow-[0_0_15px_rgba(0,255,255,0.1)] font-mono text-xs hidden md:block min-w-[180px]">
        <div class="text-cyan-400 font-bold mb-2 uppercase tracking-widest border-b border-white/10 pb-1 flex items-center gap-2">
            <i data-lucide="cloud" class="w-3 h-3"></i> Leeds_Env_Data
        </div>
        <div id="weather-content" class="text-gray-300 space-y-1">
            <span class="animate-pulse">Connecting Sat-Link...</span>
        </div>
    </div>

    <div id="map" class="w-full h-screen z-0" style="margin-top: 50px;"></div>

    <div class="ticker-wrap">
        <div class="ticker-move" id="news-ticker">
            <div class="ticker-item">System Online...</div>
            <div class="ticker-item">Connecting to Backend Node...</div>
        </div>
    </div>

    <div id="sidebar" class="fixed top-0 right-0 h-full w-96 bg-black/95 border-l border-white/10 p-8 transform translate-x-full z-[1100] pt-24 shadow-2xl flex flex-col overflow-y-auto pb-6">
        <button onclick="closeSidebar()" class="text-gray-500 hover:text-white mb-6 flex items-center gap-2 text-xs uppercase font-bold tracking-widest">
            <i data-lucide="arrow-right"></i> Close Terminal
        </button>
        
        <div class="mb-4">
            <div class="flex justify-between items-start mb-3">
                <span id="bug-badge" class="inline-block px-3 py-1 rounded-sm text-[10px] font-bold uppercase tracking-widest border">Critical</span>
                <button onclick="upvoteCurrentBug()" class="flex items-center gap-1 text-[10px] uppercase font-bold tracking-widest text-cyan-400 hover:text-white transition-colors">
                    <i data-lucide="thumbs-up" class="w-3 h-3"></i> <span id="bug-votes">0</span> Priority
                </button>
            </div>
            <h2 id="bug-title" class="text-2xl font-bold mb-2 leading-tight">Title</h2>
            <div id="bug-desc" class="text-gray-400 text-sm mb-4 font-mono leading-relaxed">No description.</div>
            
            <div id="bug-link-container" class="hidden mt-2 mb-4">
                <a id="bug-link" href="#" target="_blank" class="block w-full text-center bg-blue-600 hover:bg-blue-500 text-white py-2 rounded text-xs font-bold uppercase">Read Full Article</a>
            </div>

            <div class="flex justify-between text-gray-500 text-xs font-mono border-b border-white/10 pb-4">
                <div class="flex items-center gap-2"><i data-lucide="map-pin" class="w-3 h-3"></i> <span id="bug-location">Loc</span></div>
                <div id="bug-time">Just now</div>
            </div>
        </div>
        
        <div class="bg-white/5 border border-white/10 p-4 rounded mb-6 font-mono text-xs">
            <div class="text-cyan-400 font-bold mb-2 flex items-center gap-2 uppercase tracking-widest">
                <i data-lucide="cpu" class="w-3 h-3 animate-pulse"></i> Neural Net Audit
            </div>
            <div class="space-y-2 text-gray-400">
                <div class="flex justify-between"><span>Confidence:</span> <span class="text-white" id="ai-conf">...</span></div>
                <div class="flex justify-between"><span>Est. Cost:</span> <span class="text-white" id="ai-cost">...</span></div>
                <div class="flex justify-between"><span>Authority:</span> <span class="text-white" id="ai-dept">...</span></div>
            </div>
        </div>

        <div class="flex-1 flex flex-col mb-16 border-t border-white/10 pt-4">
            <h3 class="text-xs font-bold text-cyan-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                <i data-lucide="message-square" class="w-3 h-3"></i> Community Link
            </h3>
            
            <div id="chat-history" class="flex-1 bg-zinc-900/50 border border-white/5 rounded p-3 overflow-y-auto min-h-[150px] mb-3 space-y-3">
                <div class="text-center text-gray-600 text-[10px] italic py-4">Connecting to node frequency...</div>
            </div>

            <div class="flex gap-2">
                <input type="text" id="chat-input" 
                    onkeypress="if(event.key === 'Enter') postComment()"
                    placeholder="Add intel..." 
                    class="flex-1 bg-zinc-900 border border-zinc-700 text-white text-xs p-2 rounded focus:border-cyan-500 outline-none">
                <button onclick="postComment()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-3 rounded text-xs font-bold transition-colors">
                    <i data-lucide="send" class="w-3 h-3"></i>
                </button>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 p-6 bg-black/95 border-t border-white/10">
            <button id="verify-btn" class="w-full py-3 bg-zinc-800 border border-zinc-600 text-zinc-400 font-bold uppercase tracking-widest text-sm flex items-center justify-center gap-2 cursor-not-allowed">
                <i data-lucide="clock" class="w-4 h-4"></i> Awaiting Council Action
            </button>
        </div>
    </div>

    <div id="reportModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[1200] hidden flex items-center justify-center p-4">
        <div class="bg-black border border-cyan-500/50 p-8 max-w-md w-full shadow-[0_0_50px_rgba(0,255,255,0.15)]">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-3 border-b border-white/10 pb-4">
                <i data-lucide="alert-circle" class="text-cyan-400"></i> REPORT ISSUE
            </h2>
            <form id="bugForm" onsubmit="handleFormSubmit(event)">
                <div class="mb-4">
                    <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-2 font-bold">Issue Title</label>
                    <input type="text" id="inputTitle" placeholder="e.g. Traffic Light Failure" class="w-full bg-white/5 border border-white/10 p-3 text-white focus:border-cyan-500 focus:outline-none transition-colors font-mono text-sm" required>
                </div>
                <div class="mb-4">
                    <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-2 font-bold">Description</label>
                    <textarea id="inputDesc" rows="2" placeholder="Details..." class="w-full bg-white/5 border border-white/10 p-3 text-white focus:border-cyan-500 focus:outline-none transition-colors font-mono text-sm"></textarea>
                </div>
                <div class="mb-4">
                    <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-2 font-bold">Upload Photo (Optional)</label>
                    <input type="file" id="inputPhoto" accept="image/*" class="w-full bg-white/5 border border-white/10 p-2 text-gray-400 focus:border-cyan-500 focus:outline-none transition-colors text-xs">
                </div>
                <div class="mb-8">
                    <label class="block text-[10px] uppercase tracking-widest text-gray-500 mb-2 font-bold">Priority Level</label>
                    <div class="grid grid-cols-2 gap-2">
                        <label class="cursor-pointer group">
                            <input type="radio" name="severity" value="low" class="peer hidden">
                            <div class="p-2 border border-white/10 text-center text-[10px] uppercase font-bold text-gray-400 peer-checked:bg-blue-900/30 peer-checked:border-blue-500 peer-checked:text-blue-400 transition-all hover:bg-white/5">Low</div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="severity" value="normal" class="peer hidden" checked>
                            <div class="p-2 border border-white/10 text-center text-[10px] uppercase font-bold text-gray-400 peer-checked:bg-cyan-900/30 peer-checked:border-cyan-500 peer-checked:text-cyan-400 transition-all hover:bg-white/5">Normal</div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="severity" value="traffic" class="peer hidden">
                            <div class="p-2 border border-white/10 text-center text-[10px] uppercase font-bold text-gray-400 peer-checked:bg-orange-900/30 peer-checked:border-orange-500 peer-checked:text-orange-400 transition-all hover:bg-white/5">Traffic</div>
                        </label>
                        <label class="cursor-pointer group">
                            <input type="radio" name="severity" value="critical" class="peer hidden">
                            <div class="p-2 border border-white/10 text-center text-[10px] uppercase font-bold text-gray-400 peer-checked:bg-pink-900/30 peer-checked:border-pink-500 peer-checked:text-pink-400 transition-all hover:bg-white/5">Critical</div>
                        </label>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 border border-white/10 font-bold hover:bg-white/5 text-xs uppercase tracking-widest text-gray-400">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-cyan-500 text-black font-bold hover:bg-cyan-400 shadow-[0_0_20px_rgba(0,255,255,0.3)] text-xs uppercase tracking-widest">Submit Report</button>
                </div>
            </form>
        </div>
    </div>

    <button onclick="enableReportMode()" class="fixed bottom-10 right-10 w-16 h-16 bg-cyan-500 hover:bg-white text-black rounded-full shadow-[0_0_30px_rgba(0,255,255,0.4)] z-[1000] flex items-center justify-center transition-all hover:scale-110 group border-4 border-black mb-8">
        <i data-lucide="plus" class="w-8 h-8 group-hover:rotate-90 transition-transform duration-300"></i>
    </button>

    <script>
        // --- INITIAL SETUP ---
        lucide.createIcons();
        const map = L.map('map', { zoomControl: false }).setView([53.8008, -1.5491], 13);
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'OpenGrid UK | Powered by OSRM', subdomains: 'abcd', maxZoom: 20 }).addTo(map);
        L.control.zoom({ position: 'bottomleft' }).addTo(map);

        const API_URL = "http://localhost:3000/api/bugs";
        let bugs = [];
        let markerLayers = [];
        let trafficLayers = []; 
        let newsLayers = [];
        let trafficPolyline = null;
        let isTrafficOn = false;
        let isNewsOn = false;
        let heatLayer = null;
        let isHeatMode = false;
        let currentBugId = null;
        let userXP = parseInt(localStorage.getItem('opengrid_xp')) || 0;

        // --- FETCH DATA ---
        async function fetchBugs() {
            try {
                const res = await fetch(API_URL);
                bugs = await res.json();
                document.getElementById('bug-count').innerText = bugs.length;
                renderMap();
                updateTicker();
            } catch (e) { 
                console.error("Server Offline. Using Fallback.");
            }
        }

        // --- CHAT FUNCTIONS ---
        async function loadComments(bugId) {
            const container = document.getElementById('chat-history');
            container.innerHTML = `<div class="text-center text-gray-500 text-[10px] animate-pulse">Scanning comms...</div>`;
            
            try {
                const res = await fetch(`http://localhost:3000/api/comments/${bugId}`);
                const comments = await res.json();
                
                if (comments.length === 0) {
                    container.innerHTML = `<div class="text-center text-gray-600 text-[10px] italic py-4">No chatter on this frequency.</div>`;
                } else {
                    container.innerHTML = comments.map(c => {
                        const time = new Date(c.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        return `
                            <div class="flex flex-col mb-2 items-start">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[9px] font-bold text-cyan-400">anonymous</span>
                                    <span class="text-[8px] text-gray-600">${time}</span>
                                </div>
                                <div class="bg-zinc-800 border border-cyan-900 rounded px-2 py-1 text-[11px] text-gray-300 max-w-[90%]">
                                    ${c.text}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            } catch (e) {
                container.innerHTML = `<div class="text-red-500 text-[10px]">Comms Offline.</div>`;
            }
        }

        async function postComment() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !currentBugId) return;

            try {
                await fetch('http://localhost:3000/api/comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bug_id: currentBugId, username: 'anonymous', text: text })
                });
                input.value = ''; // Clear input
                loadComments(currentBugId); // Refresh
            } catch (e) {
                alert("Failed to send transmission.");
            }
        }

        // --- REAL-TIME WEATHER API ---
        async function fetchWeather() {
            try {
                const lat = 53.8008; // Leeds
                const lng = -1.5491;
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`);
                const data = await res.json();
                const w = data.current_weather;
                
                let condition = "STABLE";
                let colorClass = "text-green-400";
                
                if (w.weathercode > 50) { condition = "RAIN"; colorClass = "text-blue-400"; }
                if (w.weathercode > 70) { condition = "SNOW"; colorClass = "text-white"; }
                if (w.temperature > 25) { condition = "HEAT"; colorClass = "text-red-400"; }
                
                const html = `
                    <div class="flex justify-between gap-4"><span>TEMP:</span> <span class="text-white">${w.temperature}Â°C</span></div>
                    <div class="flex justify-between gap-4"><span>WIND:</span> <span class="text-white">${w.windspeed} km/h</span></div>
                    <div class="mt-1 pt-1 border-t border-white/10 flex justify-between">
                        <span>STATUS:</span> <span class="${colorClass} font-bold">${condition}</span>
                    </div>
                `;
                document.getElementById('weather-content').innerHTML = html;
            } catch (e) {
                document.getElementById('weather-content').innerText = "OFFLINE";
            }
        }

        // --- ROBUST TRAFFIC TOGGLE ---
        async function toggleRealTraffic() {
            const btn = document.getElementById('traffic-btn');
            
            if (isTrafficOn) {
                trafficLayers.forEach(layer => map.removeLayer(layer));
                trafficLayers = [];
                if (trafficPolyline) { map.removeLayer(trafficPolyline); trafficPolyline = null; }
                isTrafficOn = false;
                btn.classList.remove('bg-orange-900/50', 'text-white');
                btn.innerHTML = `<i data-lucide="activity" class="w-3 h-3"></i> Live Traffic`;
                lucide.createIcons();
                return;
            }

            isTrafficOn = true;
            btn.classList.add('bg-orange-900/50', 'text-white');
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-3 h-3"></i> Syncing...`;
            lucide.createIcons();

            try {
                const proxyUrl = "https://api.allorigins.win/get?url=";
                const targetUrl = encodeURIComponent("https://m.highwaysengland.co.uk/feeds/rss/UnplannedEvents.xml");
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 4000);
                const response = await fetch(proxyUrl + targetUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data.contents, "text/xml");
                const items = xmlDoc.getElementsByTagName("item");

                if (items.length === 0) throw new Error("No Data");

                let importCount = 0;
                for (let i = 0; i < Math.min(items.length, 5); i++) {
                    const title = items[i].getElementsByTagName("title")[0].textContent;
                    const exists = bugs.some(b => b.title === title);
                    if (!exists) {
                        const point = items[i].getElementsByTagName("point")[0];
                        const desc = items[i].getElementsByTagName("description")[0].textContent;
                        
                        if (point) {
                            const coords = point.textContent.split(' ');
                            const lat = parseFloat(coords[0]);
                            const lng = parseFloat(coords[1]);

                            const newIncident = {
                                lat, lng, title, desc, type: 'traffic', loc: `Lat: ${lat.toFixed(3)}`, time: Date.now()
                            };

                            await fetch(API_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(newIncident)
                            });
                            importCount++;
                        }
                    }
                }
                
                await fetchBugs(); 
                alert(importCount > 0 ? `SYNC COMPLETE: ${importCount} incidents imported from Govt Feed.` : "SYNC COMPLETE: System up to date.");

            } catch (e) {
                console.warn("Sync Failed, using Predictive Mode.");
                const weatherText = document.getElementById('weather-content').innerText;
                const isBadWeather = weatherText.includes("RAIN") || weatherText.includes("SNOW");
                const color = isBadWeather ? '#ef4444' : '#f97316'; 
                
                const routeCoords = [[53.8068, -1.5550], [53.8042, -1.5500], [53.8000, -1.5480], [53.7950, -1.5450], [53.7920, -1.5300]];
                
                trafficPolyline = L.polyline(routeCoords, { color: color, weight: 8, opacity: 0.9, dashArray: '20, 30', className: 'traffic-anim' }).addTo(map);

                const fakePoints = [{ lat: 53.8042, lng: -1.5500, title: "Predicted Congestion (M62)" }];
                fakePoints.forEach(p => {
                    const iconHtml = `<div class="marker-pin prediction"></div>`;
                    const customIcon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [20, 20], iconAnchor: [10, 10] });
                    const marker = L.marker([p.lat, p.lng], { icon: customIcon }).addTo(map);
                    marker.bindPopup(`<strong style="color: #f97316">ðŸ”® PREDICTIVE AI</strong><br>${p.title}`);
                    trafficLayers.push(marker);
                });

                map.fitBounds(trafficPolyline.getBounds(), { padding: [50, 50] });
                
                if (!document.getElementById('traffic-style')) {
                    const style = document.createElement('style');
                    style.id = 'traffic-style';
                    style.innerHTML = `.traffic-anim { animation: dash 60s linear infinite; }`;
                    document.head.appendChild(style);
                }
                alert(`âš  SYNC FAILED (CORS). Switching to PREDICTIVE MODE.`);
            }

            btn.innerHTML = `<i data-lucide="activity" class="w-3 h-3"></i> Live Traffic`;
            lucide.createIcons();
        }

        // --- NEWS TOGGLE ---
        async function toggleNews() {
            const btn = document.getElementById('news-btn');
            if (isNewsOn) {
                newsLayers.forEach(layer => map.removeLayer(layer));
                newsLayers = [];
                isNewsOn = false;
                btn.classList.remove('bg-blue-900/50', 'text-white');
                return;
            }

            isNewsOn = true;
            btn.classList.add('bg-blue-900/50', 'text-white');
            
            try {
                const proxyUrl = "https://api.allorigins.win/get?url=";
                const targetUrl = encodeURIComponent("https://feeds.bbci.co.uk/news/england/leeds_and_west_yorkshire/rss.xml");
                const response = await fetch(proxyUrl + targetUrl);
                const data = await response.json();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(data.contents, "text/xml");
                const items = xmlDoc.getElementsByTagName("item");

                const cities = { "Bradford": [53.7957, -1.7593], "Wakefield": [53.6800, -1.4900], "York": [53.9600, -1.0800], "Leeds": [53.8008, -1.5491] };

                for (let i = 0; i < items.length; i++) {
                    const title = items[i].getElementsByTagName("title")[0].textContent;
                    const link = items[i].getElementsByTagName("link")[0].textContent;
                    let lat = 53.8008 + (Math.random() * 0.05 - 0.025);
                    let lng = -1.5491 + (Math.random() * 0.05 - 0.025);

                    for (const [city, coords] of Object.entries(cities)) {
                        if (title.includes(city)) { lat = coords[0]; lng = coords[1]; break; }
                    }

                    const iconHtml = `<div class="marker-pin news"></div>`;
                    const customIcon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [20, 20], iconAnchor: [10, 10] });
                    const newsItem = { id: 'news-'+i, title: "NEWS: " + title, desc: "Click to read full story.", type: 'news', link: link, loc: 'BBC Feed' };
                    
                    const marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
                    marker.on('click', () => openSidebar(newsItem));
                    newsLayers.push(marker);
                }
            } catch (e) { alert("News Feed Unavailable."); }
            lucide.createIcons();
        }

        // --- RENDER MAP ---
        function renderMap() {
            markerLayers.forEach(layer => map.removeLayer(layer));
            markerLayers = [];
            if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }

            if (isHeatMode) {
                const activeBugs = bugs.filter(b => b.type !== 'resolved');
                const heatPoints = activeBugs.map(b => {
                    let intensity = 0.4;
                    if (b.type === 'critical') intensity = 1.0;
                    if (b.type === 'traffic') intensity = 0.7;
                    if (b.type === 'news') intensity = 0.2;
                    return [b.lat, b.lng, intensity];
                });

                heatLayer = L.heatLayer(heatPoints, { 
                    radius: 35, blur: 20, maxZoom: 14, max: 1.0,
                    gradient: { 0.2: '#0000ff', 0.4: '#00ffff', 0.6: '#00ff00', 0.8: '#ff00ff', 1.0: '#ffffff' } 
                }).addTo(map);

            } else {
                bugs.forEach((bug) => {
                    let typeClass = bug.type;
                    if(bug.type === 'traffic') typeClass = 'traffic';
                    if(bug.type === 'news') typeClass = 'news';
                    let style = bug.type === 'resolved' ? 'opacity:0.5;' : '';

                    const iconHtml = `<div class="marker-pin ${typeClass}" style="${style}"></div>`;
                    const customIcon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [20, 20], iconAnchor: [10, 10] });
                    const marker = L.marker([bug.lat, bug.lng], { icon: customIcon }).addTo(map);
                    markerLayers.push(marker);
                    marker.on('click', () => openSidebar(bug));
                });
            }
        }

        // --- UI LOGIC ---
        function openSidebar(bug) {
            const sidebar = document.getElementById('sidebar');
            const linkContainer = document.getElementById('bug-link-container');
            const linkBtn = document.getElementById('bug-link');
            
            sidebar.classList.remove('translate-x-full');
            currentBugId = bug.id;

            document.getElementById('bug-title').innerText = bug.title;
            document.getElementById('bug-desc').innerText = bug.desc || "No details.";
            document.getElementById('bug-location').innerHTML = bug.loc;
            
            // Update bug badge based on type
            const badge = document.getElementById('bug-badge');
            const typeMap = { 'critical': 'Critical', 'traffic': 'Traffic Alert', 'news': 'News', 'resolved': 'Resolved' };
            const badgeType = bug.type || 'normal';
            const badgeText = typeMap[badgeType] || 'Standard';
            badge.innerText = badgeText;
            
            // Update badge styling based on type
            badge.className = 'inline-block px-3 py-1 rounded-sm text-[10px] font-bold uppercase tracking-widest border';
            if (badgeType === 'critical') {
                badge.className += ' bg-pink-900/30 border-pink-500 text-pink-400';
            } else if (badgeType === 'traffic') {
                badge.className += ' bg-orange-900/30 border-orange-500 text-orange-400';
            } else if (badgeType === 'news') {
                badge.className += ' bg-blue-900/30 border-blue-500 text-blue-400';
            } else if (badgeType === 'resolved') {
                badge.className += ' bg-green-900/30 border-green-500 text-green-400';
            } else {
                badge.className += ' bg-cyan-900/30 border-cyan-500 text-cyan-400';
            }
            
            if (bug.type === 'news' && bug.link) {
                linkContainer.classList.remove('hidden');
                linkBtn.href = bug.link;
            } else {
                linkContainer.classList.add('hidden');
            }

            const btn = document.getElementById('verify-btn');
            if (bug.type === 'resolved') {
                btn.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i> ISSUE RESOLVED`;
                btn.className = "absolute bottom-6 left-6 right-6 py-4 bg-green-900/50 border border-green-500 text-green-400 font-bold uppercase tracking-widest text-sm flex items-center justify-center gap-2 cursor-default";
                btn.onclick = null;
            } else {
                btn.innerHTML = `<i data-lucide="clock" class="w-4 h-4"></i> AWAITING COUNCIL ACTION`;
                btn.className = "absolute bottom-6 left-6 right-6 py-4 bg-zinc-800 border border-zinc-600 text-zinc-400 font-bold uppercase tracking-widest text-sm flex items-center justify-center gap-2 cursor-not-allowed";
                btn.onclick = () => alert("Only authorized Council Staff can resolve incidents. Your vote has been logged.");
            }
            
            // Populate AI Audit Data
            document.getElementById('ai-conf').innerText = bug.confidence ? (bug.confidence * 100).toFixed(0) + '%' : '85%';
            document.getElementById('ai-cost').innerText = bug.estimated_cost || 'Â£2,500';
            document.getElementById('ai-dept').innerText = bug.authority || 'Leeds Council';
            
            // LOAD CHAT
            loadComments(bug.id);
            lucide.createIcons();
        }

        async function upvoteCurrentBug() {
            const bug = bugs.find(b => b.id === currentBugId);
            if (bug) {
                bug.votes = (bug.votes || 0) + 1;
                document.getElementById('bug-votes').innerText = bug.votes;
                await fetch(`${API_URL}/${bug.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ votes: bug.votes })
                });
            }
        }

        async function applyFilters() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            
            // Filter bugs based on search and type
            let filtered = bugs.filter(bug => {
                const matchesSearch = !searchInput || 
                    bug.title.toLowerCase().includes(searchInput) || 
                    bug.desc.toLowerCase().includes(searchInput) || 
                    bug.loc.toLowerCase().includes(searchInput);
                
                const matchesType = !typeFilter || bug.type === typeFilter;
                
                return matchesSearch && matchesType;
            });
            
            // Sort by votes (popularity) if search is active
            if (searchInput || typeFilter) {
                filtered.sort((a, b) => (b.votes || 0) - (a.votes || 0));
            }
            
            // Update bug count
            document.getElementById('bug-count').innerText = filtered.length;
            
            // Render filtered results
            markerLayers.forEach(layer => map.removeLayer(layer));
            markerLayers = [];
            
            filtered.forEach((bug) => {
                const typeClass = bug.type;
                const style = bug.type === 'resolved' ? 'opacity:0.5;' : '';
                const iconHtml = `<div class="marker-pin ${typeClass}" style="${style}"></div>`;
                const customIcon = L.divIcon({ className: 'custom-div-icon', html: iconHtml, iconSize: [20, 20], iconAnchor: [10, 10] });
                const marker = L.marker([bug.lat, bug.lng], { icon: customIcon }).addTo(map);
                markerLayers.push(marker);
                marker.on('click', () => openSidebar(bug));
            });
            
            // Fly to first result if search is active
            if ((searchInput || typeFilter) && filtered.length > 0) {
                map.flyTo([filtered[0].lat, filtered[0].lng], 15, { animate: true, duration: 1.5 });
                setTimeout(() => openSidebar(filtered[0]), 500);
            }
        }
        
        // Real-time search as user types
        document.getElementById('searchInput').addEventListener('input', () => {
            applyFilters();
        });
        
        // Real-time filter by type change
        document.getElementById('filterType').addEventListener('change', () => {
            applyFilters();
        });

        function toggleHeatmap() {
            isHeatMode = !isHeatMode;
            document.getElementById('heat-btn').classList.toggle('bg-pink-900/50');
            renderMap();
        }

        function updateTicker() {
            if(bugs.length === 0) return;
            const headlines = bugs.slice(-5).reverse().map(b => 
                `<span class="ticker-item"><span class="${b.type==='critical'?'text-pink-500':'text-cyan-500'}">[${b.type.toUpperCase()}]</span> ${b.title}</span>`
            ).join("");
            document.getElementById('news-ticker').innerHTML = headlines + headlines;
        }

        function toggleTheme() {
            let isDark = document.body.style.filter === 'invert(1)';
            document.body.style.filter = isDark ? 'none' : 'invert(1)';
        }

        function closeSidebar() { document.getElementById('sidebar').classList.add('translate-x-full'); }
        function openModal() { document.getElementById('reportModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('reportModal').classList.add('hidden'); }
        
        let tempLocation = null;
        function enableReportMode() {
            document.getElementById('map').style.cursor = 'crosshair';
            map.once('click', function(e) { tempLocation = e.latlng; openModal(); document.getElementById('map').style.cursor = 'grab'; });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const title = document.getElementById('inputTitle').value;
            const desc = document.getElementById('inputDesc').value;
            const type = document.querySelector('input[name="severity"]:checked').value;
            const photoInput = document.getElementById('inputPhoto');
            
            let image = null;
            if (photoInput.files && photoInput.files[0]) {
                const file = photoInput.files[0];
                const reader = new FileReader();
                image = await new Promise((resolve) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            }
            
            const newBug = {
                lat: tempLocation.lat,
                lng: tempLocation.lng,
                title, desc, type,
                loc: `Lat: ${tempLocation.lat.toFixed(4)}`,
                time: Date.now(),
                image: image
            };
            
            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newBug)
            });

            fetchBugs();
            closeModal();
            document.getElementById('bugForm').reset();
        }

        function logout() {
            localStorage.removeItem('opengrid_user');
            window.location.href = 'login.html';
        }

        // Initialize app
        fetchBugs();
        fetchWeather();
        setInterval(fetchWeather, 600000);
        
        // Setup search and filter event listeners after DOM is ready
        setTimeout(() => {
            const searchInput = document.getElementById('searchInput');
            const filterType = document.getElementById('filterType');
            
            if (searchInput) {
                searchInput.addEventListener('input', applyFilters);
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') applyFilters();
                });
            }
            
            if (filterType) {
                filterType.addEventListener('change', applyFilters);
            }
        }, 100);
    </script>
</body>
</html>